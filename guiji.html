<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.0/jquery.js"></script>
    <title>Document</title>
</head>
<body>
    <div class="content">
        <canvas id="canvas" width="375"></canvas>
        <video id="awesome" width="375" height="599" controls autoplay loop></video>
        <img src="/img/zhuzhai.jpg" alt="" id="img" style="width: 375px;">
        <img src="/img/top.png" alt="" srcset="" id="top">
        <img src="/img/bottom.png" alt="" id="bottom">
        <img src="/img/click.png" alt="" id="touch">
        <img src="/img/baozhang.jpg" alt="" class="baozhang" id="baozhang">
        <img src="/img/tiaokuan.jpg" alt="" class="tiaokuan" id="tiaokuan">
        <img src="/img/xuzhi.jpg" alt="" class="xuzhi" id="xuzhi">
        <img src="/img/yinsi.jpg" alt="" class="yinsi" id="yinsi">
        <img src="/img/newbottom.jpg" alt="" id="newbottom">
        <a id="link"></a>
        <button class="play">播放</button>
        <button class="createVideo">生成视频</button>
        <a style="display:none" id="download" download="clock.webm">Download video</a>
    </div>
    <canvas id="bgcanvas" width="375"></canvas>

    <script src="/js/whammy.js"></script>
    <script src="/js/data.js"></script>
    <script src="/js/data1.js"></script>
    <style>
        * {
            padding: 0;
            margin: 0;
        }
        #canvas {
            border: 1px solid #333333;
            margin-top: 50px;
        }
        .content {
            width: 100%;
            height: 100vh;
        }
        #img, #top, #bottom, #bgcanvas, .baozhang, .tiaokuan, .xuzhi, .yinsi {
            display: none;
        }
    </style>
    <script>
        let ctxList = []
        $(() => {
            let list = data1List()
            list.forEach((item, index) => {
                if (index == 0) {
                    item.interval = 0
                } else {
                    item.interval = item.time - list[index - 1].time
                }
            })
            let time = 0
            var video = new Whammy.Video(20);
            const canvas = document.getElementById('canvas')
            canvas.height = 599
            const ctx = canvas.getContext('2d')
            const touch = document.getElementById('touch')
            let img = document.getElementById('img')
            const bottom = document.getElementById('bottom')
            const newbottom = document.getElementById('newbottom')
            ctx.drawImage(bottom, 0, 0, 375, 50, 0, 549, 375, 50)
            ctx.drawImage(img, 0, 0, 375, 549, 0, 0, 375, 549)
            const bgcanvas = document.getElementById('bgcanvas')
            bgcanvas.height = 3014
            const bgctx = bgcanvas.getContext('2d')
            bgctx.drawImage(img, 0, 0, 375, 3014)
            const xuzhi = document.getElementById('xuzhi')
            const tiaokuan = document.getElementById('tiaokuan')
            const yinsi = document.getElementById('yinsi')
            const baozhang = document.getElementById('baozhang')
            // // 须知画布
            let mycanvas = bgcanvas
            // ctx.drawImage(touch, 155, 237)


            function finalizeVideo(){
                var start_time = +new Date;
                video.compile(false, function(output){         
                    var end_time = +new Date;
                    var url = URL.createObjectURL(output); 
                    console.log("url:"+url);
                    document.getElementById('awesome').src = url
                    document.getElementById('download').style.display = '';
                    document.getElementById('download').href = url;
                })
            }

            // $('.play').click(e => {
            //     e.preventDefault()
            //     list.forEach((item, index) => {
            //         setTimeout(() => {
            //             let h = 667 + item.top
            //             if (item.type == 2) {
            //                 bgctx.font = '14px SourceHanSansCN-Regular'
            //                 bgctx.fillText(item.value.value, item.left, item.top - 15)
            //                 ctx.drawImage(mycanvas, 0, top, 375, 549, 0, 0, 375, 549)
            //             } else if (item.type == 3) {
            //                 console.log(item)
            //                 const preImg = ctx.getImageData(0, 0, 375, 599)
            //                 ctx.drawImage(touch, item.left, item.top)
            //                 if (list[index + 1].interval > 500) {
            //                     setTimeout(() => {
            //                         ctx.putImageData(preImg, 0, 0)
            //                     }, 500)
            //                 }
            //             } else if (item.type == 4) {
            //                 if (item.name == 'xuzhi') {
            //                     mycanvas = xuzhi
            //                 } else if (item.name == 'tiaokuan') {
            //                     mycanvas = tiaokuan
            //                 } else if (item.name == 'yinsi') {
            //                     mycanvas = yinsi
            //                 } else if (item.name == 'baozhang') {
            //                     mycanvas = baozhang
            //                 }
            //                 ctx.drawImage(mycanvas, 0, item.top, 375, 524, 0, 32, 375, 524)
            //             } else {
            //                 top = item.top
            //                 ctx.drawImage(mycanvas, 0, item.top, 375, 549, 0, 0, 375, 549)
            //             }
            //             const no = item.interval / 50
            //             for (let i = 0; i < no; i++) {
            //                 video.add(ctx)
            //             }
            //         }, time)
            //         time += item.interval
            //     })
            // })
            function createVideos () {
                let top = 0
                let newTop = 0
                let h = 549
                const createVideo = function (index) {
                    const item = list[index]
                    if (item.type == 2) {
                        bgctx.font = '14px SourceHanSansCN-Regular'
                        bgctx.fillText(item.value.value, item.left, item.top - 15)
                        ctx.drawImage(mycanvas, 0, top, 375, h, 0, newTop, 375, h)
                    } else if (item.type == 3) {
                        ctx.drawImage(touch, item.left, item.top - 68)
                    } else if (item.type == 4) {
                        if (item.name == 'xuzhi') {
                            mycanvas = xuzhi
                        } else if (item.name == 'tiaokuan') {
                            mycanvas = tiaokuan
                        } else if (item.name == 'yinsi') {
                            mycanvas = yinsi
                        } else if (item.name == 'baozhang') {
                            mycanvas = baozhang
                        }
                        newTop = 32
                        h = 524
                        ctx.clearRect(0, 0, 375, 599)
                        ctx.drawImage(mycanvas, 0, item.top, 375, h, 0, newTop, 375, h)
                        ctx.drawImage(newbottom, 0, 0, 375, 43, 0, 556, 375, 43)
                    } else {
                        top = item.top
                        ctx.drawImage(mycanvas, 0, item.top, 375, h, 0, newTop, 375, h)
                    }
                    const no = item.interval / 50
                    for (let i = 0; i < no; i++) {
                        video.add(ctx)
                    }
                    if (index < list.length - 1) {
                        setTimeout(() => {
                            createVideo(index +1)
                        }, 1)
                    } else {
                        console.log('生成结束' + new Date())
                        requestAnimationFrame(finalizeVideo)
                    }
                }.bind(this)
                createVideo(0)
            }


            $('.play').click(e => {
                e.preventDefault()
                console.log('生成开始' + new Date())
                createVideos()
            })

            $('.createVideo').click(e => {
                e.preventDefault()
                console.log(JSON.stringify(ctxList))
                console.log(ctxList.length)
                // ctxList.forEach((item, index) => {
                //     video.add(item)
                //     if (index == ctxList.length - 1) {
                //         requestAnimationFrame(finalizeVideo)
                //     }
                // })
                requestAnimationFrame(finalizeVideo)
            })
        })
    </script>
</body>
</html>