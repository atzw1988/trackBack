<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.0/jquery.js"></script>
    <title>Document</title>
</head>
<body>
    <div class="content">
        <!-- <canvas id="videocanvas" width="375"></canvas> -->
        <canvas id="canvas" width="375"></canvas>
        <video id="awesome" width="375" height="667" controls autoplay loop></video>
        <img src="/img/zhuzhai.jpg" alt="" id="img">
        <img src="/img/top.jpg" alt="" id="top" style="display:none">
        <img src="/img/newtop.jpg" alt="" id="newtop" style="display:none">
        <img src="/img/bottom.jpg" alt="" id="bottom" style="display:none">
        <img src="/img/click.png" alt="" id="touch">
        <img src="/img/baozhang.jpg" alt="" class="baozhang" id="baozhang">
        <img src="/img/tiaokuan.jpg" alt="" class="tiaokuan" id="tiaokuan">
        <img src="/img/xuzhi.jpg" alt="" class="xuzhi" id="xuzhi">
        <img src="/img/yinsi.jpg" alt="" class="yinsi" id="yinsi">
        <img src="/img/newbottom.jpg" alt="" id="newbottom" style="display:none">
        <img src="/img/bg.jpg" alt="" id="bg" style="display:none">
        <img src="/img/mytop.jpg" alt="" id="mytop" style="display:none">
        <a id="link"></a>
        <button class="play">播放</button>
        <button class="createVideo">生成视频</button>
        <a style="display:none" id="download" download="clock.webm">Download video</a>
    </div>
    <canvas id="bgcanvas" width="375"></canvas>

    <script src="/js/whammy.js"></script>
    <script src="/js/data.js"></script>
    <script src="/js/data1.js"></script>
    <style>
        * {
            padding: 0;
            margin: 0;
        }
        #canvas {
            border: 1px solid #333333;
            margin-top: 50px;
        }
        .content {
            width: 100%;
            height: 100vh;
        }
        #img, #bgcanvas, .baozhang, .tiaokuan, .xuzhi, .yinsi {
            display: none;
        }
    </style>
    <script>
        let ctxList = []
        $(() => {
            let list = dataList()
            list.forEach((item, index) => {
                if (index == 0) {
                    item.interval = 0
                } else {
                    item.interval = item.time - list[index - 1].time
                }
            })
            let time = 0
            var video = new Whammy.Video(25);
            const canvas = document.getElementById('canvas')
            canvas.height = 667
            const ctx = canvas.getContext('2d')
            const touch = document.getElementById('touch')
            const img = document.getElementById('img')
            const top = document.getElementById('top')
            const bottom = document.getElementById('bottom')
            const newbottom = document.getElementById('newbottom')
            const bg = document.getElementById('bg')
            const mytop = document.getElementById('mytop')
            const newtop = document.getElementById('newtop')
            const bgcanvas = document.getElementById('bgcanvas')
            bgcanvas.height = 3005
            const bgctx = bgcanvas.getContext('2d')
            bgctx.drawImage(img, 0, 0, 375, 3005)
            const xuzhi = document.getElementById('xuzhi')
            const tiaokuan = document.getElementById('tiaokuan')
            const yinsi = document.getElementById('yinsi')
            const baozhang = document.getElementById('baozhang')
            let mycanvas = bgcanvas


            function finalizeVideo(){
                var start_time = +new Date;
                video.compile(false, function(output){         
                    var end_time = +new Date;
                    var url = URL.createObjectURL(output); 
                    console.log("url:"+url);
                    document.getElementById('awesome').src = url
                    document.getElementById('download').style.display = '';
                    document.getElementById('download').href = url;
                })
            }
            function createVideos () {
                let newTop = 0
                let h = 549
                let top = 0
                const createVideo = function (index) {
                    const item = list[index]
                    if (item.type == 2) {
                        bgctx.font = '14px SourceHanSansCN-Regular'
                        bgctx.fillText(item.value.value, item.left, item.top - 15)
                        ctx.drawImage(mycanvas, 0, top, 375, h, 0, newTop, 375, h)
                    } else if (item.type == 3) {
                        ctx.drawImage(touch, item.left, item.top)
                    } else if (item.type == 4) {
                        if (item.name == 'zhuzhai') {
                            h = 549
                            newTop = 68
                            mycanvas = bgcanvas
                            ctx.drawImage(bg, 0, 0, 375, 667, 0, 0, 375, 667)
                            ctx.drawImage(mycanvas, 0, item.top, 375, h, 0, newTop, 375, h)
                        } else {
                            h = 524
                            newTop = 100
                            if (item.name == 'xuzhi') {
                                mycanvas = xuzhi
                            } else if (item.name == 'tiaokuan') {
                                mycanvas = tiaokuan
                            } else if (item.name == 'yinsi') {
                                mycanvas = yinsi
                            } else if (item.name == 'baozhang') {
                                mycanvas = baozhang
                            }
                            ctx.drawImage(newbottom, 0, 0, 375, 43, 0, 624, 375, 43)
                            ctx.drawImage(newtop, 0, 0, 375, 100, 0, 0, 375, 100)
                            ctx.drawImage(mycanvas, 0, item.top, 375, h, 0, newTop, 375, h)
                        }
                    } else {
                        top = item.top
                        ctx.drawImage(mycanvas, 0, item.top, 375, h, 0, newTop, 375, h)
                    }
                    const no = item.interval / 40
                    for (let i = 0; i < no; i++) {
                        video.add(ctx)
                    }
                    if (index < list.length - 1) {
                        setTimeout(() => {
                            createVideo(index +1)
                        }, 1)
                    } else {
                        console.log('生成结束' + new Date())
                        requestAnimationFrame(finalizeVideo)
                    }
                }.bind(this)
                createVideo(0)
            }
            // function createVideos () {
            //     let newTop = 0
            //     let h = 549
            //     const createVideo = function (index) {
            //         const item = list[index]
            //         if (item.type == 2) {
            //             bgctx.font = '14px SourceHanSansCN-Regular'
            //             bgctx.fillText(item.value.value, item.left, item.top - 15)
            //             ctx.drawImage(mycanvas, 0, top, 375, h, 0, newTop, 375, h)
            //         } else if (item.type == 3) {
            //             ctx.drawImage(touch, item.left, item.top)
            //         } else if (item.type == 4) {
            //             if (item.name == 'zhuzhai') {
            //                 h = 549
            //                 newTop = 68
            //                 mycanvas = bgcanvas
            //                 ctx.drawImage(bg, 0, 0, 375, 667, 0, 0, 375, 667)
            //                 ctx.drawImage(mycanvas, 0, item.top, 375, h, 0, newTop, 375, h)
            //             } else {
            //                 h = 524
            //                 newTop = 100
            //                 if (item.name == 'xuzhi') {
            //                     mycanvas = xuzhi
            //                 } else if (item.name == 'tiaokuan') {
            //                     mycanvas = tiaokuan
            //                 } else if (item.name == 'yinsi') {
            //                     mycanvas = yinsi
            //                 } else if (item.name == 'baozhang') {
            //                     mycanvas = baozhang
            //                 }
            //                 ctx.drawImage(newbottom, 0, 0, 375, 43, 0, 624, 375, 43)
            //                 ctx.drawImage(newtop, 0, 0, 375, 100, 0, 0, 375, 100)
            //                 ctx.drawImage(mycanvas, 0, item.top, 375, h, 0, newTop, 375, h)
            //             }
            //         } else {
            //             ctx.drawImage(mycanvas, 0, item.top, 375, h, 0, newTop, 375, h)
            //         }
            //         video.add(ctx)
            //         if (index < list.length - 1) {
            //             setTimeout(() => {
            //                 createVideo(index +1)
            //             }, 1)
            //         } else {
            //             console.log('生成结束' + new Date())
            //             requestAnimationFrame(finalizeVideo)
            //         }
            //     }.bind(this)
            //     createVideo(0)
            // }


            $('.play').click(e => {
                e.preventDefault()
                console.log('生成开始' + new Date())
                createVideos()
            })

            $('.createVideo').click(e => {
                e.preventDefault()
                console.log(JSON.stringify(ctxList))
                console.log(ctxList.length)
                requestAnimationFrame(finalizeVideo)
            })
        })
    </script>
</body>
</html>